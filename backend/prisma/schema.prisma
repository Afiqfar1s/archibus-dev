generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== USERS & ROLES ==========
model Role {
  id        Int        @id @default(autoincrement())
  name      String     @unique // ADMIN, SUPERVISOR, TECHNICIAN, REQUESTOR
  createdAt DateTime   @default(now()) @map("created_at")
  userRoles UserRole[]

  @@map("roles")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String
  passwordHash String?  @map("password_hash") // nullable for SSO users
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  roles                     UserRole[]
  technician                Technician?
  requestedServiceRequests  ServiceRequest[]            @relation("RequestedBy")
  requestedForServiceRequests ServiceRequest[]          @relation("RequestedFor")
  comments                  ServiceRequestComment[]
  attachments               ServiceRequestAttachment[]
  auditLogs                 ServiceRequestAudit[]

  @@map("users")
}

model UserRole {
  id     Int  @id @default(autoincrement())
  userId Int  @map("user_id")
  roleId Int  @map("role_id")
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// ========== LOCATION HIERARCHY ==========
model Site {
  id               Int              @id @default(autoincrement())
  code             String           @unique
  name             String
  createdAt        DateTime         @default(now()) @map("created_at")
  buildings        Building[]
  serviceRequests  ServiceRequest[]

  @@map("sites")
}

model Building {
  id              Int              @id @default(autoincrement())
  siteId          Int              @map("site_id")
  code            String
  name            String
  createdAt       DateTime         @default(now()) @map("created_at")
  site            Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  floors          Floor[]
  serviceRequests ServiceRequest[]

  @@unique([siteId, code])
  @@index([siteId])
  @@map("buildings")
}

model Floor {
  id              Int              @id @default(autoincrement())
  buildingId      Int              @map("building_id")
  code            String
  name            String
  createdAt       DateTime         @default(now()) @map("created_at")
  building        Building         @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms           Room[]
  serviceRequests ServiceRequest[]

  @@unique([buildingId, code])
  @@index([buildingId])
  @@map("floors")
}

model Room {
  id              Int              @id @default(autoincrement())
  floorId         Int              @map("floor_id")
  code            String
  name            String
  createdAt       DateTime         @default(now()) @map("created_at")
  floor           Floor            @relation(fields: [floorId], references: [id], onDelete: Cascade)
  serviceRequests ServiceRequest[]

  @@unique([floorId, code])
  @@index([floorId])
  @@map("rooms")
}

// ========== TRADES & TECHNICIANS ==========
model Trade {
  id              Int              @id @default(autoincrement())
  code            String           @unique
  name            String
  createdAt       DateTime         @default(now()) @map("created_at")
  technicians     Technician[]
  serviceRequests ServiceRequest[]

  @@map("trades")
}

model Technician {
  id              Int              @id @default(autoincrement())
  userId          Int              @unique @map("user_id")
  tradeId         Int?             @map("trade_id")
  phone           String?
  createdAt       DateTime         @default(now()) @map("created_at")
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  trade           Trade?           @relation(fields: [tradeId], references: [id], onDelete: SetNull)
  serviceRequests ServiceRequest[]

  @@index([tradeId])
  @@map("technicians")
}

// ========== PROBLEM TYPES ==========
model ProblemType {
  id              Int              @id @default(autoincrement())
  code            String           @unique
  name            String
  description     String?
  createdAt       DateTime         @default(now()) @map("created_at")
  serviceRequests ServiceRequest[]

  @@map("problem_types")
}

// ========== SERVICE REQUESTS ==========
enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ServiceRequestStatus {
  DRAFT
  SUBMITTED
  TRIAGED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CLOSED
  CANCELLED
}

model ServiceRequest {
  id                    Int            @id @default(autoincrement())
  srNumber              String         @unique @map("sr_number") // SR-YYYYMM-00001
  title                 String
  description           String
  siteId                Int            @map("site_id")
  buildingId            Int            @map("building_id")
  floorId               Int            @map("floor_id")
  roomId                Int            @map("room_id")
  problemTypeId         Int            @map("problem_type_id")
  priority              Priority       @default(MEDIUM)
  requestedByUserId     Int            @map("requested_by_user_id")
  requestedForUserId    Int?           @map("requested_for_user_id")
  assignedTradeId       Int?           @map("assigned_trade_id")
  assignedTechnicianId  Int?           @map("assigned_technician_id")
  status                ServiceRequestStatus @default(DRAFT)
  responseDueAt         DateTime?      @map("response_due_at")
  resolveDueAt          DateTime?      @map("resolve_due_at")
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  site              Site                       @relation(fields: [siteId], references: [id])
  building          Building                   @relation(fields: [buildingId], references: [id])
  floor             Floor                      @relation(fields: [floorId], references: [id])
  room              Room                       @relation(fields: [roomId], references: [id])
  problemType       ProblemType                @relation(fields: [problemTypeId], references: [id])
  requestedBy       User                       @relation("RequestedBy", fields: [requestedByUserId], references: [id])
  requestedFor      User?                      @relation("RequestedFor", fields: [requestedForUserId], references: [id])
  assignedTrade     Trade?                     @relation(fields: [assignedTradeId], references: [id], onDelete: SetNull)
  assignedTechnician Technician?               @relation(fields: [assignedTechnicianId], references: [id], onDelete: SetNull)
  comments          ServiceRequestComment[]
  attachments       ServiceRequestAttachment[]
  auditLogs         ServiceRequestAudit[]

  @@index([status])
  @@index([createdAt])
  @@index([siteId])
  @@index([buildingId])
  @@index([srNumber])
  @@index([requestedByUserId])
  @@index([assignedTechnicianId])
  @@map("service_requests")
}

// ========== COMMENTS & ATTACHMENTS ==========
model ServiceRequestComment {
  id               Int            @id @default(autoincrement())
  serviceRequestId Int            @map("service_request_id")
  userId           Int            @map("user_id")
  body             String
  createdAt        DateTime       @default(now()) @map("created_at")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [userId], references: [id])

  @@index([serviceRequestId])
  @@map("service_request_comments")
}

model ServiceRequestAttachment {
  id               Int            @id @default(autoincrement())
  serviceRequestId Int            @map("service_request_id")
  userId           Int            @map("user_id")
  fileName         String         @map("file_name")
  fileUrl          String         @map("file_url") // placeholder URL for now
  createdAt        DateTime       @default(now()) @map("created_at")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [userId], references: [id])

  @@index([serviceRequestId])
  @@map("service_request_attachments")
}

// ========== AUDIT LOG ==========
model ServiceRequestAudit {
  id               Int                      @id @default(autoincrement())
  serviceRequestId Int                      @map("service_request_id")
  userId           Int                      @map("user_id")
  action           String                   // e.g., "CREATED", "SUBMITTED", "ASSIGNED", "STATUS_CHANGED"
  fromStatus       ServiceRequestStatus?    @map("from_status")
  toStatus         ServiceRequestStatus?    @map("to_status")
  metaJson         String?                  @map("meta_json") // JSON string for additional metadata
  createdAt        DateTime                 @default(now()) @map("created_at")
  serviceRequest   ServiceRequest           @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  user             User                     @relation(fields: [userId], references: [id])

  @@index([serviceRequestId])
  @@index([createdAt])
  @@map("service_request_audit")
}
